# Metron API Caching

## Проблема

Metron API имеет ограничения:
- **30 запросов в минуту**
- **10000 запросов в день**

При 55 тысячах комиксов это означает:
- Минимум **5.5 дней** для полного заполнения кеша
- Необходимость кеширования для избежания повторных запросов

## Решение

### 1. Кеширование в базе данных

Добавлено поле `metronImageUrl` в таблицу `cdb_comics` для хранения URL изображений из Metron.

### 2. Автоматическое кеширование

Функция `getMetronImageUrl()` теперь:
1. Сначала проверяет кеш в БД
2. Если в кеше нет - запрашивает Metron API
3. Сохраняет результат в БД для будущих запросов

### 3. Batch Processing Script

Скрипт `scripts/fill-metron-cache.ts` для постепенного заполнения кеша:
- Учитывает ограничения (30/мин, 10000/день)
- Показывает прогресс и статистику
- Можно запускать многократно (пропускает уже обработанные)

## Применение миграции

### На production (Vercel/MySQL):

```sql
ALTER TABLE `cdb_comics` ADD COLUMN `metron_image_url` VARCHAR(500) NULL;
```

Или через Prisma:

```bash
npx prisma db push
```

## Запуск batch processing

```bash
npx tsx scripts/fill-metron-cache.ts
```

Скрипт будет:
- Обрабатывать комиксы батчами по 1000
- Соблюдать rate limits (30 запросов/минуту)
- Останавливаться при достижении дневного лимита (10000)
- Показывать прогресс каждые 100 комиксов

## Время заполнения

При 10000 запросов в день:
- **55,000 комиксов** = **5.5 дней**

Можно запускать скрипт каждый день до полного заполнения.

## Мониторинг

Скрипт показывает:
- Прогресс обработки
- Количество найденных/не найденных изображений
- Использованные запросы (из 10000/день)
- ETA до завершения

