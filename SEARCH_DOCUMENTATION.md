# Документация поискового механизма

## Обзор

Поисковый механизм ComicsDB реализован с использованием MySQL и Prisma ORM. Система поддерживает поиск по различным типам сущностей с разными стратегиями поиска для каждого типа.

## Архитектура поиска

### Типы поиска

1. **Поиск по сериям** - частичный поиск по одному слову (точные и частичные совпадения)
2. **Поиск по персонажам** - точное совпадение в списке через запятую
3. **Поиск по авторам** - точное совпадение с обработкой ролей в скобках
4. **Поиск по командам** - точное совпадение в списке через запятую
5. **Поиск по сканлейтерам** - точное совпадение в полях translate/edit

### Ключевые принципы

1. **Точное совпадение для авторов/персонажей/команд/сканлейтеров**
   - Используется для предотвращения ложных срабатываний
   - Например, поиск "ERA" не должен находить "Imperators"
   - Обрабатывает различные форматы данных (с пробелами, без пробелов, с ролями в скобках)

2. **Обработка HTML-сущностей**
   - На странице комикса данные декодируются через `decodeHtmlEntities()`
   - В базе данных данные могут быть закодированы (например, `&#39;` вместо `'`)
   - Поиск выполняется как по декодированному запросу, так и по закодированному через `encodeHtmlEntities()`

3. **Обработка списков через запятую**
   - Используется `FIND_IN_SET()` для поиска в списках
   - Обрабатываются различные форматы разделителей: `, `, `,`
   - Учитываются роли в скобках: `Name (role)` - для авторов

4. **Конвертация типов**
   - MySQL возвращает ID как `BigInt`, а Prisma ожидает `Int`
   - Все ID конвертируются в `Number` перед использованием в Prisma запросах

## Функции поиска

### `encodeHtmlEntities(query: string): string`

Кодирует специальные символы в HTML-сущности для поиска в базе данных.

**Пример:**
```typescript
encodeHtmlEntities("Shi'ar") // → "Shi&#39;ar"
```

### `decodeHtmlEntities(text: string): string`

Декодирует HTML-сущности в тексте (используется для отображения данных).

**Пример:**
```typescript
decodeHtmlEntities("Shi&#39;ar") // → "Shi'ar"
```

### `processComicSearchResults()`

Вспомогательная функция для обработки результатов поиска комиксов:
- Конвертирует BigInt ID в Number
- Загружает полную информацию о комиксах из Prisma
- Сортирует результаты
- Обрабатывает сайты и серии
- Формирует финальный результат

### `searchByCharacters(query, page, sort)`

Поиск комиксов по персонажам.

**Стратегия:**
- Точное совпадение в поле `characters`
- Поиск по декодированному и закодированному запросу
- Использует `FIND_IN_SET()` для поиска в списке через запятую

**Пример запроса:**
```sql
WHERE FIND_IN_SET('Wolverine', REPLACE(c.characters, ', ', ',')) > 0
   OR FIND_IN_SET('Wolverine&#39;', REPLACE(c.characters, ', ', ',')) > 0
```

### `searchByCreators(query, page, sort)`

Поиск комиксов по авторам.

**Стратегия:**
- Точное совпадение в поле `creators`
- Обрабатывает формат с ролями: `Name (role)`
- Поиск по декодированному и закодированному запросу
- Использует `FIND_IN_SET()` и `LIKE` для поиска с ролями

**Пример запроса:**
```sql
WHERE FIND_IN_SET('Stan Lee', REPLACE(REPLACE(REPLACE(c.creators, ', ', ','), ' (', ','), ')', '')) > 0
   OR c.creators LIKE 'Stan Lee (%'
   OR c.creators LIKE '%, Stan Lee (%'
```

### `searchByTeams(query, page, sort)`

Поиск комиксов по командам.

**Стратегия:**
- Точное совпадение в поле `teams`
- Аналогично поиску по персонажам

### `searchByScanlators(query, page, sort)`

**ВАЖНО:** Поиск по сканлейтерам использует ТОЛЬКО точное совпадение.

**Стратегия:**
- Ищет точное совпадение в полях `translate` или `edit`
- НЕ использует частичный поиск (`contains`)
- Это критично для различения похожих ников (например, "ERA" и "Imperators")

**Пример:**
- Запрос "ERA" найдет только комиксы, где в `translate` или `edit` есть точно "ERA"
- Запрос "ERA" НЕ найдет комиксы с "Imperators"

**SQL-запрос:**
```sql
WHERE (
  FIND_IN_SET('ERA', REPLACE(c.translate, ', ', ',')) > 0
  OR FIND_IN_SET('ERA', REPLACE(c.edit, ', ', ',')) > 0
  OR c.translate = 'ERA'
  OR c.edit = 'ERA'
)
```

### `getScanlatorStats(name)`

Получение статистики сканлейтера.

**Стратегия:**
- Использует ТОЛЬКО точное совпадение
- Подсчитывает количество переводов и оформлений
- Вычисляет время в сканлейте

## Обработка данных

### HTML-сущности

Все данные в базе могут содержать HTML-сущности:
- `&#39;` → `'`
- `&quot;` → `"`
- `&amp;` → `&`

**Важно:** На странице комикса данные декодируются через `decodeHtmlEntities()`, но в базе они могут быть закодированы. Поэтому поиск выполняется как по декодированному запросу (как приходит из URL), так и по закодированному (как может быть в базе).

### Конвертация типов

MySQL возвращает ID как `BigInt` (например, `59988n`), а Prisma ожидает обычные `Int`. Все ID конвертируются в `Number` перед использованием в Prisma запросах:

```typescript
const comicIds = exactComics.map(c => Number(c.id))
```

### Форматы списков

Поле может содержать значения в различных форматах:
- `"Name1, Name2"` (с пробелом после запятой)
- `"Name1,Name2"` (без пробела)
- `"Name1 (role), Name2"` (с ролями в скобках)

Все форматы обрабатываются автоматически.

## Производительность

### Индексы

В базе данных созданы индексы для ускорения поиска:
- `cdb_comics.date_delete` - для фильтрации удаленных записей
- `cdb_comics.serie` - для связи с сериями
- `cdb_comics.site`, `cdb_comics.site2` - для связи с сайтами

### Оптимизация запросов

1. **Использование `DISTINCT`** - предотвращает дубликаты
2. **Ограничение результатов** - `LIMIT` и `OFFSET` для пагинации
3. **Кэширование** - глобальные события кэшируются в памяти

## Тестирование

### Тестовые сценарии

1. **Точное совпадение сканлейтеров**
   - Запрос: "ERA"
   - Ожидается: только комиксы с "ERA", НЕ "Imperators"

2. **HTML-сущности**
   - Запрос: "Shi&#39;ar"
   - Ожидается: находит "Shi'ar" в базе

3. **Списки через запятую**
   - Запрос: "Wolverine"
   - Ожидается: находит в "Wolverine, Spider-Man"

4. **Роли в скобках**
   - Запрос: "Stan Lee"
   - Ожидается: находит "Stan Lee (writer)"

5. **Пустые результаты**
   - Запрос: "NonExistent"
   - Ожидается: пустой результат с предложениями (если есть похожие)

## Ограничения

1. **Поиск по сканлейтерам** - только точное совпадение, без частичного поиска
2. **Регистр** - поиск не чувствителен к регистру для сканлейтеров
3. **Опечатки** - не обрабатываются автоматически (только предложения)

## Будущие улучшения

1. **Полнотекстовый поиск** - для серий можно использовать MySQL FULLTEXT
2. **Fuzzy search** - для обработки опечаток
3. **Автодополнение** - для улучшения UX
4. **Кэширование результатов** - для часто используемых запросов

## Отладка

### Логирование

Все функции поиска логируют ошибки в консоль:
```typescript
console.error('Error searching by characters:', error)
```

### Проверка запросов

Для отладки можно проверить SQL-запросы через Prisma:
```typescript
prisma.$queryRaw`SELECT ...` // Выполняет SQL напрямую
```

### Типичные проблемы

1. **Ошибка "Expected Int, provided BigInt"**
   - Решение: конвертировать ID в Number перед использованием в Prisma
   - Исправлено в версии с `processComicSearchResults()`

2. **Результаты не находятся**
   - Проверить, что данные в базе и на странице имеют одинаковый формат
   - Убедиться, что поиск выполняется по обоим вариантам (декодированному и закодированному)

## Технические детали

### Обработка типов данных

**Проблема:** MySQL возвращает ID как `BigInt` (например, `59988n`), а Prisma ORM ожидает обычные `Int` для поля `id`.

**Решение:** Все ID конвертируются в `Number` перед использованием в Prisma запросах:
```typescript
const comicIds = exactComics.map(c => Number(c.id))
```

Это критично для работы поиска, так как без конвертации возникает ошибка:
```
Argument `in`: Invalid value provided. Expected Int, provided BigInt.
```

### Оптимизация кода

Для устранения дублирования кода используется вспомогательная функция `processComicSearchResults()`, которая:
- Конвертирует BigInt ID в Number
- Загружает полную информацию о комиксах
- Сортирует результаты
- Обрабатывает сайты и серии
- Формирует финальный результат

Эта функция используется в:
- `searchByCharacters()`
- `searchByCreators()`
- `searchByTeams()`

### Next.js 14 App Router

В Next.js 14 параметры `searchParams` могут быть Promise, поэтому используется:
```typescript
const resolvedParams = await Promise.resolve(searchParams)
```

## Заключение

Поисковый механизм ComicsDB спроектирован для обеспечения точности и производительности. Ключевой принцип - точное совпадение для авторов, персонажей, команд и сканлейтеров, что предотвращает ложные срабатывания и обеспечивает релевантность результатов.

Все функции поиска работают корректно и обрабатывают:
- HTML-сущности в данных
- Различные форматы списков через запятую
- Роли в скобках для авторов
- Конвертацию типов данных (BigInt → Int)

