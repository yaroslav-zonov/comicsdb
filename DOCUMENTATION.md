# ComicsDB - Полная документация проекта

## 1. ОБЩЕЕ ОПИСАНИЕ

**ComicsDB** — база данных русских переводов комиксов. Сайт предоставляет каталог комиксов с информацией об издательствах, сериях, выпусках, переводчиках и их переводах.

**Целевая аудитория:** Читатели комиксов, переводчики, модераторы

**Технологический стек:**
- Next.js 14 (App Router)
- TypeScript
- Prisma ORM
- MySQL
- Tailwind CSS

---

## 2. АРХИТЕКТУРА БАЗЫ ДАННЫХ

### 2.1 Ключевые сущности

#### Publisher (Издательство) - `cdb_publishers`
- **id** - Уникальный идентификатор
- **name** - Название издательства
- **numofcoms** - Количество комиксов
- **dateDelete** - Мягкое удаление

#### Series (Серия) - `cdb_series`
- **id** - Уникальный идентификатор
- **name** - Название серии
- **publisherId** - Связь с издательством
- **volume** - Том серии
- **zhanr** - Жанр (текстовое поле)
- **status** - Статус серии:
  - `continue` - Продолжается
  - `finish` - Завершена
  - `freez` - Заморожена
  - `comicvine` - Статус неизвестен
- **first** - Номер первого выпуска (по умолчанию "1")
- **total** - Общее количество выпусков в серии
- **comicvine** - Количество всех выпусков (из ComicVine)
- **lastIssue** - Дата последнего выпуска

#### Comic (Комикс/Выпуск) - `cdb_comics`

**ВАЖНО:** В системе используются два типа ID:
- **id** - ID перевода (может быть несколько для одного выпуска)
- **comicvine** - Постоянный идентификатор выпуска (используется в URL)

**Атрибуты:**
- **id** - ID перевода (автоинкремент)
- **serieId** - Связь с серией
- **number** - Номер выпуска
- **comicvine** - Постоянный ID выпуска (используется в URL)
- **pdate** - Дата публикации
- **date** - Дата перевода
- **site** - ID сайта переводчика (основной)
- **site2** - ID второго сайта (для совместных релизов)
- **link** - Ссылка на скачивание (основная)
- **link2** - Ссылка на скачивание (для совместных релизов)
- **translate** - Переводчик(и) через запятую
- **edit** - Оформитель(и) через запятую
- **creators** - Создатели (формат: "Имя (роль), Имя (роль)")
- **characters** - Персонажи (формат: "Имя (роль), Имя")
- **teams** - Команды
- **thumb**, **tiny**, **small**, **super** - URL изображений разных размеров

**Логика множественных переводов:**
- Один выпуск (номер) может иметь несколько переводов
- Это разные записи в `cdb_comics` с одинаковым `serieId` и `number`
- Все переводы одного выпуска имеют одинаковый `comicvine` ID
- В URL используется `comicvine` ID как постоянный идентификатор

**Совместные релизы:**
- Когда две команды делают совместный релиз, это одна запись
- В такой записи заполнены и `site` и `site2`
- Отображаются как одна строка с двумя командами через запятую
- Логика: если есть `site2`, показываем обе команды

#### Site (Сайт переводчиков) - `cdb_sites`
- **id** - Уникальный идентификатор (строка)
- **name** - Название сайта
- **url** - Ссылка на сайт
- **birthday** - Дата создания сайта
- **lastTranslation** - Дата последнего перевода
- **deathday** - Дата закрытия сайта
- **paper** - Официальное издание на бумаге (NO/YES)
- **numofcoms** - Количество комиксов (выпусков)
- **numofcomsreal** - Количество серий
- **showlink** - Отображать ссылку на сайт
- **hidesite** - Скрывать сайт

---

## 3. СТРУКТУРА URL И НАВИГАЦИЯ

### 3.1 URL структура

**Формат:** `/publishers/[publisherId]/[seriesId]/[comicId]`

Где:
- `publisherId` - ID издательства
- `seriesId` - ID серии
- `comicId` - **comicvine ID** (постоянный идентификатор выпуска)

**ВАЖНО:** 
- В URL используется `comicvine` ID, а не `id` из `cdb_comics`
- Один `comicvine` ID может иметь несколько записей в `cdb_comics` (разные переводы)
- Старые URL `/comics/[id]` и `/series/[id]` редиректят на новый формат

### 3.2 Навигация по выпускам

- Навигация происходит по **номерам выпусков**, а не по ID комиксов
- При навигации "следующий/предыдущий" используется `comicvine` ID
- Если у одного номера несколько переводов, используется `comicvine` ID первого найденного

### 3.3 Хлебные крошки

Полный путь: **Главная → Издательство → Серия → Выпуск**

---

## 4. СТРАНИЦЫ И ФУНКЦИОНАЛЬНОСТЬ

### 4.1 Главная страница (`/`)

**Блоки:**
1. **Новые серии** - Первые выпуски новых серий (5 карточек, горизонтальный скролл на мобильных)
2. **Свежие релизы** - Все комиксы за последние 7 дней
   - Переключатель между карточками и таблицей
   - Табличный вид скрыт на мобильных

### 4.2 Страница издательства (`/publishers/[publisherId]`)

**Отображается:**
- Название издательства
- Все серии издательства
- Пагинация и переключение между карточками/таблицей

### 4.3 Страница серии (`/publishers/[publisherId]/[seriesId]`)

**Отображается:**
- Название серии, издательство, год
- Статус серии и статус перевода
- Жанры (кликабельные)
- Метаданные: количество переведённых выпусков, общее количество
- Все выпуски серии:
  - Карточный вид: уникальные выпуски (по номеру)
  - Табличный вид: все переводы (включая дубли)
  - Переключатель между видами

**Статус перевода:**
- "Завершён" - если переведено столько же или больше, сколько всего выпусков
- "Заморожен" - если в течение полугода переводов не было
- "Продолжается" - в остальных случаях

### 4.4 Страница выпуска (`/publishers/[publisherId]/[seriesId]/[comicId]`)

**Отображается:**
- Обложка (большая)
- Название серии и номер выпуска
- Издательство и дата публикации
- Создатели, персонажи, команды (кликабельные, открывают поиск)
- Глобальные события (если есть)
- Все переводы в таблице:
  - Сайт-переводчик (если совместный релиз - обе команды через запятую)
  - Переводчик(и) - каждый через запятую кликабельный
  - Оформитель(и) - каждый через запятую кликабельный
  - Дата публикации
  - Кнопка скачать

**Навигация:**
- Предыдущий/следующий выпуск по номеру

### 4.5 Страница поиска (`/search`)

**Табы:**
1. **По сериям** - широкий поиск по названиям серий
2. **Персонажам** - точное вхождение в поле `characters`
3. **Авторам** - точное вхождение в поле `creators`
4. **Сканлейтерам** - точное вхождение в поля `translate` или `edit`
   - Показывает статистику: всего комиксов, перевёл, оформил, времени в сканлейте, последний релиз
5. **Командам** - точное вхождение в поле `teams`

**Функции:**
- Если нет точных совпадений, предлагает похожие варианты
- Фильтры сортировки: по алфавиту, дате публикации, дате перевода
- Переключение между карточками и таблицей
- Пагинация с номерами страниц

### 4.6 Страница сайта переводчиков (`/sites/[id]`)

**Отображается:**
- Название сайта
- Статистика: количество комиксов, серий
- Все переведённые серии

---

## 5. КОМПОНЕНТЫ

### 5.1 Унифицированные компоненты

#### `ComicCard` - Карточка комикса
- Показывает обложку, название, сайт переводчика
- Поддерживает `site2Name` для совместных релизов
- Настраиваемые поля через props

#### `TableRow` - Строка таблицы
- Унифицированный компонент для всех таблиц
- Разные варианты: `main`, `comic-page`, `character-creator-team`, `scanlator`, `series`
- Поддерживает совместные релизы (две команды через запятую)
- Настраиваемые поля через props

#### `ComicsListView` - Список комиксов с переключением вида
- Переключение между карточками и таблицей
- Группировка по номеру выпуска (для карточек)
- Настраиваемые поля

#### `SeriesListView` - Список серий с переключением вида
- Переключение между карточками и таблицей
- Пагинация

#### `ViewToggle` - Переключатель вида
- Иконки для карточек и таблицы
- Скрыт на мобильных для таблицы

### 5.2 Утилиты (`lib/utils.ts`)

- `decodeHtmlEntities` - Декодирует HTML-сущности
- `getComicUrl` - Генерирует URL для комикса
- `getSeriesUrl` - Генерирует URL для серии
- `getTranslationStatus` - Вычисляет статус перевода серии

---

## 6. ЛОГИКА ПОИСКА

### 6.1 Поиск по сериям
- Широкий поиск: `contains` в названии серии
- Отображает серии

### 6.2 Поиск по персонажам/авторам/командам/сканлейтерам
- Точное вхождение: `FIND_IN_SET` или точное совпадение
- Если нет точных совпадений, предлагает похожие варианты
- Отображает комиксы (выпуски)

### 6.3 Приоритеты поиска
- Сначала ищутся точные совпадения
- Если не найдено, предлагаются похожие варианты
- Для сканлейтеров: приоритет точным совпадениям, отображается реальный ник

---

## 7. ОБРАБОТКА ДАННЫХ

### 7.1 HTML-сущности
- Все текстовые поля декодируются через `decodeHtmlEntities`
- Примеры: `&#39;` → `'`, `&quot;` → `"`, `&amp;` → `&`

### 7.2 Изображения
- Замена `scale_avatar` на `scale_large` в URL
- Приоритет размеров: `super` > `thumb` > `small` > `tiny`

### 7.3 Совместные релизы
- Если в записи есть `site2`, это совместный релиз
- Отображаются обе команды через запятую
- Логика упрощена: проверяется только наличие `site2`, без проверки `link` и `link2`

---

## 8. ТЕХНИЧЕСКИЕ ДЕТАЛИ

### 8.1 Динамические маршруты
- Все страницы используют `export const dynamic = 'force-dynamic'`
- Это необходимо для работы с базой данных

### 8.2 Редиректы
- `/comics/[id]` → `/publishers/[publisherId]/[seriesId]/[comicvineId]`
- `/series/[id]` → `/publishers/[publisherId]/[seriesId]`

### 8.3 Типизация
- Все компоненты типизированы через TypeScript
- Используются типы из Prisma Client

### 8.4 Стилизация
- Tailwind CSS для всех стилей
- Акцентный цвет: оранжевый (`orange-600`)
- Адаптивный дизайн (mobile-first)

---

## 9. СТРУКТУРА ПРОЕКТА

```
comicsdb/
├── app/                          # Next.js App Router
│   ├── (pages)/                 # Группировка маршрутов
│   │   └── page.tsx            # Главная страница
│   ├── api/                     # API endpoints
│   │   ├── comics/            # API для комиксов
│   │   ├── series/            # API для серий
│   │   └── publishers/         # API для издательств
│   ├── comics/[id]/           # Старый формат (редирект)
│   ├── series/[id]/           # Старый формат (редирект)
│   ├── publishers/             # Новый формат URL
│   │   └── [publisherId]/
│   │       ├── page.tsx       # Страница издательства
│   │       └── [seriesId]/
│   │           ├── page.tsx   # Страница серии
│   │           └── [comicId]/
│   │               └── page.tsx # Страница выпуска
│   ├── search/                 # Страница поиска
│   ├── sites/[id]/             # Страница сайта переводчиков
│   ├── layout.tsx              # Root layout
│   └── globals.css             # Глобальные стили
│
├── components/                  # React компоненты
│   ├── ComicCard.tsx          # Карточка комикса
│   ├── ComicsListView.tsx     # Список комиксов с переключением
│   ├── SeriesListView.tsx     # Список серий с переключением
│   ├── TableRow.tsx           # Строка таблицы
│   ├── ViewToggle.tsx         # Переключатель вида
│   ├── Header.tsx             # Шапка сайта
│   ├── Footer.tsx             # Подвал сайта
│   ├── NewSeries.tsx          # Новые серии
│   ├── FreshReleases.tsx      # Свежие релизы (клиент)
│   ├── FreshReleasesServer.tsx # Свежие релизы (сервер)
│   ├── RandomSeries.tsx       # Случайная серия
│   ├── SeriesComicsView.tsx   # Выпуски серии
│   └── SearchResultsView.tsx  # Результаты поиска
│
├── lib/                        # Утилиты
│   ├── prisma.ts             # Prisma client
│   └── utils.ts               # Вспомогательные функции
│
├── prisma/                     # Prisma схема
│   └── schema.prisma
│
└── scripts/                    # Скрипты
    └── import-mysql-dump.ts   # Импорт дампа
```

---

## 10. ПРИНЦИПЫ CLEAN CODE

### 10.1 Организация кода
- Компоненты разделены на серверные и клиентские
- Утилиты вынесены в отдельные файлы
- Типы определены рядом с компонентами или в utils

### 10.2 Именование
- Компоненты: PascalCase
- Функции: camelCase
- Константы: UPPER_SNAKE_CASE
- Файлы: соответствуют именам компонентов

### 10.3 DRY (Don't Repeat Yourself)
- Унифицированные компоненты для повторяющихся паттернов
- Общие утилиты для обработки данных
- Переиспользование логики через функции

### 10.4 Single Responsibility
- Каждый компонент отвечает за одну задачу
- Функции делают одну вещь
- Разделение серверной и клиентской логики

---

## 11. БУДУЩИЕ УЛУЧШЕНИЯ

- [ ] Оптимизация запросов к БД (индексы, кэширование)
- [ ] Улучшение поиска (FULLTEXT, SOUNDEX для опечаток)
- [ ] Добавление фильтров на страницах списков
- [ ] Реализация авторизации и личных списков
- [ ] Добавление комментариев
- [ ] Оптимизация изображений (Next.js Image optimization)

---

**Последнее обновление:** Декабрь 2024
